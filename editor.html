<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScolaireDocs AI - Pro Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&family=Open+Sans&family=Playfair+Display&family=Roboto&family=Merriweather&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f0f2f5; font-family: 'Open Sans', sans-serif; }

        /* Conteneur pour simuler les pages A4 */
        #document-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }

        .paper {
            background: white;
            width: 210mm;
            min-height: 297mm; /* Hauteur A4 */
            padding: 20mm;
            margin: 15px 0;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
            outline: none;
            position: relative;
            overflow-wrap: break-word;
        }

        .google-toolbar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: #f9fbfd;
            border-bottom: 1px solid #dfe1e5;
        }

        .ai-badge {
            background: linear-gradient(90deg, #4285f4, #9b51e0);
            color: white;
            padding: 2px 7px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
        }

        .stats-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dfe1e5;
            padding: 5px 20px;
            font-size: 12px;
            color: #5f6368;
            display: flex;
            gap: 20px;
            z-index: 100;
        }

        @media print {
            .google-toolbar, .no-print, .stats-bar { display: none !important; }
            body { background: white; }
            .paper { margin: 0; box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

    <div class="google-toolbar px-4 py-2 no-print">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/01/Google_Docs_logo_%282014-2020%29.svg" width="22">
                <input type="text" id="docTitle" value="Document Scolaire" class="bg-transparent font-medium text-gray-700 hover:border-gray-300 border border-transparent px-2 outline-none">
            </div>
            <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-1.5 rounded-full text-sm font-bold transition shadow-sm">
                <i class="fas fa-file-pdf mr-2"></i>Exporter PDF
            </button>
        </div>

        <div class="flex flex-wrap items-center gap-2 bg-white rounded-full px-4 py-1.5 border shadow-sm max-w-fit mx-auto">
            <select onchange="execCmd('fontName', this.value)" class="text-xs border-none outline-none cursor-pointer font-medium bg-transparent">
                <option value="Arial">Arial</option>
                <option value="Roboto">Roboto</option>
                <option value="Montserrat">Montserrat</option>
                <option value="Playfair Display">Playfair Display</option>
                <option value="Merriweather">Merriweather</option>
                <option value="Times New Roman">Times New Roman</option>
            </select>

            <div class="w-px h-6 bg-gray-200 mx-1"></div>

            <button onclick="execCmd('bold')" class="p-2 hover:bg-gray-100 rounded" title="Gras"><i class="fas fa-bold"></i></button>
            <button onclick="execCmd('italic')" class="p-2 hover:bg-gray-100 rounded"><i class="fas fa-italic"></i></button>
            <button onclick="execCmd('underline')" class="p-2 hover:bg-gray-100 rounded"><i class="fas fa-underline"></i></button>

            <div class="w-px h-6 bg-gray-200 mx-1"></div>

            <label class="p-2 hover:bg-gray-100 rounded cursor-pointer text-gray-600" title="Insérer une image">
                <i class="fas fa-image"></i>
                <input type="file" class="hidden" accept="image/*" onchange="insertImageLocal(this)">
            </label>

            <div class="w-px h-6 bg-gray-200 mx-1"></div>

            <button onclick="askAI()" class="flex items-center gap-2 px-3 py-1 hover:bg-purple-50 text-purple-700 rounded-full transition group">
                <i class="fas fa-magic text-purple-500"></i>
                <span class="text-xs font-bold">Llama3</span>
            </button>

            <label class="flex items-center gap-2 px-3 py-1 hover:bg-green-50 text-green-700 rounded-full cursor-pointer transition">
                <i class="fas fa-eye text-green-500"></i>
                <span class="text-xs font-bold">Llava</span>
                <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="processVision()">
            </label>
        </div>
    </div>

    <main id="document-container" class="py-4 overflow-y-auto h-[calc(100vh-140px)]">
        <div id="editor" class="paper" contenteditable="true" oninput="updateStats()">
            <h1 style="text-align: center; font-size: 24pt;">Titre du Cours</h1>
            <p>Commencez à taper vos notes ici...</p>
        </div>
    </main>

    <div class="stats-bar no-print">
        <span id="pageCount"><i class="fas fa-copy mr-1"></i> 1 Page</span>
        <span id="wordCount"><i class="fas fa-file-word mr-1"></i> 0 mots</span>
        <span id="charCount"><i class="fas fa-keyboard mr-1"></i> 0 caractères</span>
    </div>

    <div id="loader" class="hidden fixed bottom-12 right-10 bg-white shadow-2xl border-2 border-purple-500 p-4 rounded-2xl flex items-center gap-4 animate-bounce z-[100]">
        <div class="w-4 h-4 bg-purple-600 rounded-full animate-ping"></div>
        <span class="font-bold text-purple-700 italic">L'IA analyse...</span>
    </div>

    <script>
        const SERVER_IP = "100.82.161.21";
        const editor = document.getElementById('editor');

        function execCmd(cmd, val = null) {
            document.execCommand(cmd, false, val);
            editor.focus();
            updateStats();
        }

        // Insertion Image Locale (Hors IA)
        function insertImageLocal(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 8px; margin: 10px 0;">`;
                    document.execCommand('insertHTML', false, imgHTML);
                };
                reader.readAsDataURL(file);
            }
        }

        // --- IA TEXTE ---
        async function askAI() {
            const selectedText = window.getSelection().toString() || editor.innerText.slice(-600);
            toggleLoading(true);
            try {
                const response = await fetch(`http://${SERVER_IP}:11434/api/generate`, {
                    method: 'POST',
                    body: JSON.stringify({
                        model: "llama3",
                        prompt: `Rédige la suite académique de ce texte sans astérisques : "${selectedText}"`,
                        stream: false
                    })
                });
                const data = await response.json();
                document.execCommand('insertHTML', false, `<br><span style='color: #4b5563'>${data.response.replace(/\n/g, "<br>")}</span><br>`);
            } catch (err) { alert("Serveur Llama3 injoignable"); }
            finally { toggleLoading(false); updateStats(); }
        }

        // --- IA VISION ---
        async function processVision() {
            const file = document.getElementById('imageInput').files[0];
            if (!file) return;
            toggleLoading(true);
            const reader = new FileReader();
            reader.onloadend = async function() {
                const base64 = reader.result.split(',')[1];
                try {
                    const response = await fetch(`http://${SERVER_IP}:11434/api/generate`, {
                        method: 'POST',
                        body: JSON.stringify({
                            model: "llava",
                            prompt: "Analyse cet exercice ou ce document et retranscris le texte ou la solution.",
                            images: [base64], stream: false
                        })
                    });
                    const data = await response.json();
                    const resultHTML = `
                        <div style="margin:15px 0; border:1px solid #ddd; padding:10px; border-radius:10px; background:#f9f9f9;">
                            <img src="${reader.result}" style="max-width:200px; display:block; margin-bottom:10px; border-radius:5px;">
                            <div style="color:#166534; font-size:13px; font-style:italic; border-left:3px solid #34a853; padding-left:10px;">
                                <strong>Note Llava :</strong> ${data.response}
                            </div>
                        </div><p>&nbsp;</p>`;
                    document.execCommand('insertHTML', false, resultHTML);
                } catch (e) { alert("Erreur Vision"); }
                finally { toggleLoading(false); updateStats(); }
            };
            reader.readAsDataURL(file);
        }

        // --- CALCUL STATS ET PAGES ---
        function updateStats() {
            const text = editor.innerText || "";
            const charCount = text.length;
            const wordCount = text.trim() === "" ? 0 : text.trim().split(/\s+/).length;

            // Calcul des pages (Hauteur A4 ~ 1123 pixels en 96dpi)
            const height = editor.scrollHeight;
            const pages = Math.ceil(height / 1050); // Approximatif pour le visuel

            document.getElementById('charCount').innerHTML = `<i class="fas fa-keyboard mr-1"></i> ${charCount} caractères`;
            document.getElementById('wordCount').innerHTML = `<i class="fas fa-file-word mr-1"></i> ${wordCount} mots`;
            document.getElementById('pageCount').innerHTML = `<i class="fas fa-copy mr-1"></i> ${pages} Page${pages > 1 ? 's' : ''}`;
        }

        function toggleLoading(s) { document.getElementById('loader').classList.toggle('hidden', !s); }

        // Initialisation
        window.onload = () => {
            const saved = localStorage.getItem('scolaire_docs_autosave');
            if(saved) editor.innerHTML = saved;
            updateStats();
        };

        // Sauvegarde automatique
        setInterval(() => {
            localStorage.setItem('scolaire_docs_autosave', editor.innerHTML);
        }, 5000);
    </script>
</body>
</html> 
